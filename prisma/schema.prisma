// This is your Prisma schema file

generator client {
  provider        = "prisma-client-js"
  engineType      = "binary"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  USER
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique @db.VarChar(255)
  username  String   @unique @db.VarChar(100)
  password  String   @db.VarChar(255)
  role      Role     @default(USER)
  bio       String?  @db.Text
  avatar    String?  @db.VarChar(1000) // URL to avatar image
  avatarId  String?  @db.VarChar(500) @map("avatar_id") // Provider-specific ID for deletion
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  articles   Article[]
  comments   Comment[]
  favorites  Favorite[]
  followers  Follow[]   @relation("UserFollowers")
  following  Follow[]   @relation("UserFollowing")

  @@index([email])
  @@index([username])
  @@map("users")
}

model Article {
  id             Int      @id @default(autoincrement())
  slug           String   @unique @db.VarChar(255)
  title          String   @db.VarChar(255)
  description    String   @db.Text
  body           String   @db.Text
  authorId       Int      @map("author_id")
  favoritesCount Int      @default(0) @map("favorites_count")
  commentsCount  Int      @default(0) @map("comments_count")
  isPublished    Boolean  @default(true) @map("is_published")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  author   User          @relation(fields: [authorId], references: [id])
  comments Comment[]
  tags     ArticleTag[]
  favorites Favorite[]

  @@index([slug])
  @@index([authorId])
  @@index([createdAt])
  @@index([isPublished, createdAt], name: "published_recent")
  @@map("articles")
}

model Comment {
  id        Int      @id @default(autoincrement())
  body      String   @db.Text
  articleId Int      @map("article_id")
  authorId  Int      @map("author_id")
  createdAt DateTime @default(now()) @map("created_at")

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  author  User    @relation(fields: [authorId], references: [id])

  @@index([articleId])
  @@index([authorId])
  @@index([articleId, createdAt], name: "article_comments_recent")
  @@map("comments")
}

model Tag {
  id        Int      @id @default(autoincrement())
  name      String   @unique @db.VarChar(50)
  slug      String   @unique @db.VarChar(50)
  createdAt DateTime @default(now()) @map("created_at")

  articles ArticleTag[]

  @@index([name])
  @@index([slug])
  @@map("tags")
}

model ArticleTag {
  id        Int      @id @default(autoincrement())
  articleId Int      @map("article_id")
  tagId     Int      @map("tag_id")
  createdAt DateTime @default(now()) @map("created_at")

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id])

  @@unique([articleId, tagId], name: "unique_article_tag")
  @@index([articleId])
  @@index([tagId])
  @@map("article_tags")
}

model Favorite {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  articleId Int      @map("article_id")
  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([userId, articleId], name: "unique_user_article_favorite")
  @@index([userId])
  @@index([articleId])
  @@map("favorites")
}

model Follow {
  id          Int      @id @default(autoincrement())
  followerId  Int      @map("follower_id")
  followingId Int      @map("following_id")
  createdAt   DateTime @default(now()) @map("created_at")

  follower  User @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId], name: "unique_follow_relationship")
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

model EmailLog {
  id        String   @id @default(uuid())
  to        String   @db.VarChar(255)
  template  String   @db.VarChar(100)
  subject   String   @db.VarChar(255)
  jobId     String?  @map("job_id") @db.VarChar(100)
  status    String   @db.VarChar(50) // SENT, FAILED, PENDING
  error     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  @@index([to])
  @@index([status])
  @@index([createdAt])
  @@map("email_logs")
}
